@{
    ViewData["Title"] = "Reports & Analytics";
    var ticketStats = ViewBag.TicketStats;
    var projectStats = ViewBag.ProjectStats;
    var assetStats = ViewBag.AssetStats;
    var contractStats = ViewBag.ContractStats;
    var userWorkload = ViewBag.UserWorkload;
    var velocity = ViewBag.Velocity;
    var solutionStats = ViewBag.SolutionStats;
}

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-5 d-print-none">
        <div class="d-flex align-items-center gap-4">
            <div class="health-score-ring position-relative" style="width: 80px; height: 80px;">
                <svg viewBox="0 0 36 36" class="circular-chart @(ViewBag.HealthScore > 80 ? "green" : (ViewBag.HealthScore > 50 ? "orange" : "red"))">
                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    <path class="circle" stroke-dasharray="@ViewBag.HealthScore, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                </svg>
                <div class="health-score-text position-absolute top-50 start-50 translate-middle fw-bold h4 mb-0">@ViewBag.HealthScore%</div>
            </div>
            <div>
                <h1 class="display-6 fw-bold mb-1">Analytics Dashboard</h1>
                <p class="text-muted mb-0">Cross-module performance metrics and <span class="badge bg-primary-subtle text-primary border border-primary-subtle">AI Health: @(ViewBag.HealthScore > 80 ? "Optimal" : "Review Needed")</span></p>
            </div>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#reportOptionsModal">
                <i class="bi bi-gear"></i> Report Options
            </button>
        </div>
    </div>

    <!-- Report Options Modal -->
    <div class="modal fade" id="reportOptionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content glass border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold">Configure Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-4">
                    <p class="text-muted small mb-4">Select the modules you wish to include in your export or print-out.</p>
                    <div class="d-grid gap-3">
                        <div class="form-check form-switch p-0 d-flex align-items-center justify-content-between">
                            <label class="form-check-label fw-600" for="checkTickets">Tickets, Aging & Trends</label>
                            <input class="form-check-input" type="checkbox" id="checkTickets" checked>
                        </div>
                        <div class="form-check form-switch p-0 d-flex align-items-center justify-content-between">
                            <label class="form-check-label fw-600" for="checkProjects">Project Performance Table</label>
                            <input class="form-check-input" type="checkbox" id="checkProjects" checked>
                        </div>
                        <div class="form-check form-switch p-0 d-flex align-items-center justify-content-between">
                            <label class="form-check-label fw-600" for="checkAssets">Asset Inventory & Distribution</label>
                            <input class="form-check-input" type="checkbox" id="checkAssets" checked>
                        </div>
                        <div class="form-check form-switch p-0 d-flex align-items-center justify-content-between">
                            <label class="form-check-label fw-600" for="checkContracts">Financials & Active Contracts</label>
                            <input class="form-check-input" type="checkbox" id="checkContracts" checked>
                        </div>
                        <div class="form-check form-switch p-0 d-flex align-items-center justify-content-between">
                            <label class="form-check-label fw-600" for="checkSolutions">Knowledge Base & Solutions</label>
                            <input class="form-check-input" type="checkbox" id="checkSolutions" checked>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0 d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="handleSelectiveExport()">
                        <i class="bi bi-file-earmark-csv"></i> CSV
                    </button>
                    <button type="button" class="btn btn-primary btn-sm flex-grow-1" onclick="handleModernPdfExport()">
                        <i class="bi bi-file-earmark-pdf"></i> Download PDF Report
                    </button>
                </div>
            </div>
        </div>
    </div>

        <div class="d-none d-print-block mb-4 border-bottom pb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <img src="~/images/helpora-desk-logo.png" style="height: 36px; width: auto;" alt="Helpora Desk" class="mb-2" />
                <h1 class="h2 fw-bold mb-0">System Analytics Report</h1>
                <p class="text-muted">Generated on @DateTime.Now.ToString("f")</p>
            </div>
        </div>
    </div>

    <style>
        .circular-chart { display: block; margin: 10px auto; max-width: 100%; max-height: 250px; }
        .circle-bg { fill: none; stroke: #eee; stroke-width: 2.8; }
        .circle { fill: none; stroke-width: 2.8; stroke-linecap: round; animation: progress 1s ease-out forwards; }
        @@keyframes progress { 0% { stroke-dasharray: 0 100; } }
        .circular-chart.green .circle { stroke: #4cc790; }
        .circular-chart.orange .circle { stroke: #ff9f00; }
        .circular-chart.red .circle { stroke: #ff5c5c; }
        .health-score-text { color: #333; }
        .small-caps { font-variant: all-small-caps; letter-spacing: 1px; }
    </style>

    <!-- Top Level Metrics -->
    <div class="row g-4 mb-4" id="sectionMetrics">
        <div class="col-12 col-md-6 col-xl-3" id="metricAssets">
            <div class="card glass shadow-sm border-0 h-100 p-2">
                <div class="card-body">
                    <div class="text-secondary small text-uppercase fw-bold mb-1">Total Assets Value</div>
                    <div class="h3 fw-bold mb-0 text-primary">$@assetStats.TotalValue.ToString("N0")</div>
                    <div class="small text-muted mt-1">@assetStats.TotalCount total tracked items</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3" id="metricContracts">
            <div class="card glass shadow-sm border-0 h-100 p-2">
                <div class="card-body">
                    <div class="text-secondary small text-uppercase fw-bold mb-1">Contract Value</div>
                    <div class="h3 fw-bold mb-0 text-success">$@contractStats.TotalValue.ToString("N0")</div>
                    <div class="small text-danger mt-1">
                        <i class="bi bi-exclamation-circle text-danger"></i> @contractStats.UpcomingExpirations exp. soon
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3" id="metricTickets">
            <div class="card glass shadow-sm border-0 h-100 p-2">
                <div class="card-body">
                    <div class="text-secondary small text-uppercase fw-bold mb-1">Ticket Resolution</div>
                    <div class="h3 fw-bold mb-0">@ticketStats.ResolvedLast30Days</div>
                    <div class="small text-muted mt-1">Last 30 days</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-xl-3" id="metricMaintenance">
            <div class="card glass shadow-sm border-0 h-100 p-2">
                <div class="card-body">
                    <div class="text-secondary small text-uppercase fw-bold mb-1">Asset Maintenance</div>
                    <div class="h3 fw-bold mb-0 text-warning">@assetStats.MaintenanceCount</div>
                    <div class="small text-muted mt-1">Active tasks</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1: Aging & Distribution -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-lg-8">
            <div class="card glass shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Resolution Velocity (Tickets Resolved)</h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <canvas id="velocityChart" style="max-height: 300px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-4">
            <div class="card glass shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Ticket Aging Analysis</h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <canvas id="agingChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2: Distributions -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-lg-6" id="sectionTickets">
            <div class="card glass shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Ticket Distribution (By Status)</h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="row align-items-center">
                        <div class="col-md-7">
                            <canvas id="ticketStatusChart" style="max-height: 250px;"></canvas>
                        </div>
                        <div class="col-md-5">
                            <div id="ticketLegend" class="small mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-6" id="sectionAssets">
            <div class="card glass shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Asset Distribution (By Category)</h5>
                </div>
                <div class="card-body px-4 pb-4">
                    <canvas id="assetCategoryChart" style="max-height: 250px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Row -->
    <div class="row g-4">
        <div class="col-12 col-xl-8" id="sectionProjects">
            <div class="card glass shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Project Performance</h5>
                    <a href="/Projects" class="btn btn-sm btn-link text-decoration-none p-0 d-print-none">View All</a>
                </div>
                <div class="card-body p-0 mt-3">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0 border-top">
                            <thead class="bg-light-subtle small-caps">
                                <tr>
                                    <th class="ps-4">Project Name</th>
                                    <th>Status</th>
                                    <th>Tasks</th>
                                    <th class="pe-4">Progress</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var p in projectStats)
                                {
                                    var rate = p.TaskCount > 0 ? (p.CompletedTaskCount * 100 / p.TaskCount) : 0;
                                    <tr>
                                        <td class="ps-4 fw-600">@p.Name</td>
                                        <td>
                                            <span class="badge @(p.Status == "Active" ? "bg-success" : (p.Status == "Planning" ? "bg-info" : "bg-secondary"))">
                                                @p.Status
                                            </span>
                                        </td>
                                        <td>@p.CompletedTaskCount / @p.TaskCount</td>
                                        <td class="pe-4">
                                            <div class="d-flex align-items-center gap-3">
                                                <div class="progress flex-grow-1" style="height: 6px;">
                                                    <div class="progress-bar bg-primary" style="width: @rate%"></div>
                                                </div>
                                                <span class="small fw-bold">@rate%</span>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 col-xl-4" id="sectionWorkload">
            <div class="card glass shadow-sm border-0 h-100">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <h5 class="fw-bold mb-0">Team Workload (Active)</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-4">
                        @foreach (var user in userWorkload)
                        {
                            <div class="d-flex align-items-center gap-3">
                                <div class="avatar bg-primary-subtle text-primary fw-bold">
                                    @user.UserName.Substring(0, 1).ToUpper()
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-600 mb-0">@user.UserName</div>
                                    <div class="small text-muted">@user.TicketCount tickets • @user.TaskCount tasks</div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-danger-subtle text-danger rounded-pill">@(user.TicketCount + user.TaskCount)</span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <div class="col-12" id="sectionSolutions">
            <div class="card glass shadow-sm border-0">
                <div class="card-header bg-transparent border-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                    <h5 class="fw-bold mb-0">Knowledge Base Insights</h5>
                    <div class="small text-muted">@solutionStats.Published Published Articles</div>
                </div>
                <div class="card-body px-4 pb-4">
                    <div class="row g-4 align-items-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-primary-subtle rounded-4 text-center">
                                <div class="display-5 fw-bold text-primary">@solutionStats.TotalViews</div>
                                <div class="text-uppercase small fw-bold text-primary opacity-75">Total Article Views</div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <h6 class="fw-bold mb-3 small-caps">Trending Topics</h6>
                            <div class="d-flex flex-wrap gap-2">
                                @foreach(var topic in solutionStats.TopTopics)
                                {
                                    <div class="d-flex align-items-center gap-3 bg-light p-2 px-3 rounded-pill border">
                                        <i class="bi bi-tag-fill text-primary"></i>
                                        <span class="fw-600">@topic.Name</span>
                                        <span class="badge bg-white text-dark border">@topic.Count articles</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .small-caps {
        font-size: 0.75rem;
        text-uppercase: uppercase;
        letter-spacing: 0.05rem;
        color: #6c757d;
    }
    .fw-600 { font-weight: 600; }
    
    @@media print {
        body { background: white !important; color: black !important; }
        .sidebar, .topbar, .btn, .d-print-none { display: none !important; }
        .content { padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: 100% !important; }
        .card { border: 1px solid #eee !important; box-shadow: none !important; break-inside: avoid; }
        .glass { background: transparent !important; backdrop-filter: none !important; }
        .row { display: flex !important; flex-wrap: wrap !important; }
        .col-lg-6, .col-xl-3, .col-md-6 { width: 48% !important; display: inline-block !important; margin: 1% !important; }
        .col-lg-8 { width: 64% !important; display: inline-block !important; }
        .col-lg-4 { width: 32% !important; display: inline-block !important; }
        canvas { max-width: 100% !important; height: auto !important; }
    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Data from ViewBag (used by charts and PDF export)
        const ticketData       = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ticketStats.ByStatus));
        const ticketAging      = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ticketStats.Aging));
        const assetCatData     = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(assetStats.ByCategory));
        const velocityData     = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(velocity));
        const projectData      = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(projectStats));
        const workloadData     = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(userWorkload));
        const contractData     = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(contractStats.ByStatus));
        const solutionTopics   = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(solutionStats.TopTopics));
        const reportSummary = {
            tickets:   { total: @ticketStats.Total, resolved30: @ticketStats.ResolvedLast30Days,
                         aging: { d1: @ticketStats.Aging.Day1, d3: @ticketStats.Aging.Day3, d7: @ticketStats.Aging.Day7, old: @ticketStats.Aging.Older } },
            assets:    { count: @assetStats.TotalCount, value: @assetStats.TotalValue, maintenance: @assetStats.MaintenanceCount },
            contracts: { value: @contractStats.TotalValue, expiring: @contractStats.UpcomingExpirations },
            solutions: { total: @solutionStats.Total, published: @solutionStats.Published, views: @solutionStats.TotalViews },
            health:    @ViewBag.HealthScore
        };


        function handleSelectivePrint() {
            // Apply d-print-none to sections not checked
            const sections = {
                'checkTickets': ['sectionTickets', 'agingChart', 'velocityChart', 'metricTickets', 'sectionWorkload'], 
                'checkProjects': ['sectionProjects'],
                'checkAssets': ['sectionAssets', 'assetCategoryChart', 'metricAssets', 'metricMaintenance'],
                'checkContracts': ['metricContracts'],
                'checkSolutions': ['sectionSolutions']
            };

            Object.keys(sections).forEach(id => {
                const isSelected = document.getElementById(id).checked;
                const targetIds = sections[id];
                
                targetIds.forEach(targetId => {
                    const el = document.getElementById(targetId);
                    if (el) {
                        if (isSelected) el.classList.remove('d-print-none');
                        else el.classList.add('d-print-none');
                    }
                });
            });

            // Special logic for the metrics container: hide if all 4 metrics are hidden
            const mTickets = document.getElementById('checkTickets').checked;
            const mProjects = true; // Projects doesn't have a metric card yet but could
            const mAssets = document.getElementById('checkAssets').checked;
            const mContracts = document.getElementById('checkContracts').checked;

            if (!mTickets && !mAssets && !mContracts) {
                document.getElementById('sectionMetrics').classList.add('d-print-none');
            } else {
                document.getElementById('sectionMetrics').classList.remove('d-print-none');
            }

            window.print();
        }

        function handleSelectiveExport() {
            const t = document.getElementById('checkTickets').checked;
            const p = document.getElementById('checkProjects').checked;
            const a = document.getElementById('checkAssets').checked;
            const c = document.getElementById('checkContracts').checked;
            const s = document.getElementById('checkSolutions').checked;
            
            const url = `@Url.Action("ExportCsv")?includeTickets=${t}&includeProjects=${p}&includeAssets=${a}&includeContracts=${c}&includeSolutions=${s}`;
            window.location.href = url;
        }

        function handleModernPdfExport() {
            const { jsPDF } = window.jspdf;
            const selT = document.getElementById('checkTickets').checked;
            const selP = document.getElementById('checkProjects').checked;
            const selA = document.getElementById('checkAssets').checked;
            const selC = document.getElementById('checkContracts').checked;
            const selS = document.getElementById('checkSolutions').checked;

            const modal = bootstrap.Modal.getInstance(document.getElementById('reportOptionsModal'));
            if (modal) modal.hide();

            const doc = new jsPDF('p', 'mm', 'a4');
            const pageW = doc.internal.pageSize.getWidth();
            const pageH = doc.internal.pageSize.getHeight();
            const margin = 15;
            const col1 = margin;
            const contentW = pageW - margin * 2;
            let y = 0;

            // ── Helpers ──────────────────────────────────────────────────
            const dateStr = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const newPage = () => { doc.addPage(); y = margin; };
            const checkY = (needed = 20) => { if (y + needed > pageH - 20) newPage(); };

            const sectionTitle = (title) => {
                checkY(14);
                doc.setFillColor(30, 58, 138);
                doc.rect(col1, y, contentW, 8, 'F');
                doc.setFontSize(9).setTextColor(255, 255, 255).setFont(undefined, 'bold');
                doc.text(title.toUpperCase(), col1 + 4, y + 5.5);
                y += 11;
                doc.setTextColor(30, 30, 30);
            };

            const kv = (label, value, x, colW) => {
                doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(100);
                doc.text(label, x, y);
                doc.setFont(undefined, 'bold').setTextColor(30);
                doc.text(String(value), x, y + 4.5);
                return y + 10;
            };

            const autoTable = (head, rows, extra = {}) => {
                doc.autoTable({
                    startY: y,
                    head: [head],
                    body: rows,
                    margin: { left: margin, right: margin },
                    headStyles: { fillColor: [30, 58, 138], textColor: 255, fontStyle: 'bold', fontSize: 8 },
                    bodyStyles: { fontSize: 8, textColor: [30, 30, 30] },
                    alternateRowStyles: { fillColor: [245, 247, 255] },
                    styles: { cellPadding: 2.5, lineColor: [220, 220, 220], lineWidth: 0.2 },
                    ...extra
                });
                y = doc.lastAutoTable.finalY + 6;
            };

            // ── COVER PAGE ───────────────────────────────────────────────
            doc.setFillColor(30, 58, 138);
            doc.rect(0, 0, pageW, 55, 'F');
            doc.setFontSize(24).setTextColor(255, 255, 255).setFont(undefined, 'bold');
            doc.text('Helpora Desk', margin, 25);
            doc.setFontSize(13).setFont(undefined, 'normal');
            doc.text('System Analytics Report', margin, 35);
            doc.setFontSize(9).setTextColor(180, 200, 255);
            doc.text(`Generated: ${dateStr}`, margin, 45);

            // Health Score badge
            const score = reportSummary.health;
            const scoreColor = score > 80 ? [34, 197, 94] : score > 50 ? [234, 179, 8] : [239, 68, 68];
            doc.setFillColor(...scoreColor);
            doc.roundedRect(pageW - 55, 15, 40, 26, 4, 4, 'F');
            doc.setFontSize(16).setFont(undefined, 'bold').setTextColor(255);
            doc.text(`${score}%`, pageW - 35, 28, { align: 'center' });
            doc.setFontSize(7).setFont(undefined, 'normal');
            doc.text('Health Score', pageW - 35, 35, { align: 'center' });

            // Divider
            doc.setDrawColor(200).setLineWidth(0.3);
            doc.line(margin, 60, pageW - margin, 60);
            y = 68;

            // -- Modules selected summary row --
            doc.setFontSize(8).setTextColor(80).setFont(undefined, 'normal');
            const selectedModules = [selT && 'Tickets', selP && 'Projects', selA && 'Assets', selC && 'Contracts', selS && 'Knowledge Base'].filter(Boolean);
            doc.text(`Modules Included: ${selectedModules.join('  ·  ')}`, margin, y);
            y += 10;

            // ── SUMMARY STATS ────────────────────────────────────────────
            sectionTitle('Executive Summary');
            const colW = contentW / 4;
            const stats = [
                { label: 'Total Tickets', value: reportSummary.tickets.total },
                { label: 'Assets Tracked', value: reportSummary.assets.count },
                { label: 'Contract Value', value: `$${Number(reportSummary.contracts.value).toLocaleString()}` },
                { label: 'KB Articles', value: `${reportSummary.solutions.published} / ${reportSummary.solutions.total}` }
            ];
            stats.forEach((s, i) => kv(s.label, s.value, col1 + i * colW, colW));
            y += 14;

            // ── TICKETS ──────────────────────────────────────────────────
            if (selT) {
                checkY(30);
                sectionTitle('Tickets & Resolution');

                // Summary row
                doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(60);
                doc.text(`Total Tickets: ${reportSummary.tickets.total}   |   Resolved Last 30 Days: ${reportSummary.tickets.resolved30}`, col1, y);
                y += 7;

                // Aging breakdown
                autoTable(
                    ['Aging Range', 'Open Ticket Count'],
                    [
                        ['< 24 Hours (Fresh)',        reportSummary.tickets.aging.d1],
                        ['1 – 3 Days',                reportSummary.tickets.aging.d3],
                        ['3 – 7 Days',                reportSummary.tickets.aging.d7],
                        ['> 7 Days (Critical)',        reportSummary.tickets.aging.old]
                    ]
                );

                if (ticketData.length > 0) {
                    checkY(20);
                    autoTable(
                        ['Status', 'Count'],
                        ticketData.map(d => [d.Name, d.Count])
                    );
                }
            }

            // ── PROJECTS ─────────────────────────────────────────────────
            if (selP && projectData.length > 0) {
                checkY(30);
                sectionTitle('Project Performance');
                autoTable(
                    ['Project Name', 'Status', 'Tasks Done', 'Total Tasks', 'Progress'],
                    projectData.map(p => {
                        const rate = p.TaskCount > 0 ? Math.round(p.CompletedTaskCount / p.TaskCount * 100) : 0;
                        return [p.Name, p.Status, p.CompletedTaskCount, p.TaskCount, `${rate}%`];
                    })
                );
            }

            // ── ASSETS ───────────────────────────────────────────────────
            if (selA) {
                checkY(30);
                sectionTitle('Asset Inventory');

                doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(60);
                doc.text(`Total Assets: ${reportSummary.assets.count}   |   Total Value: $${Number(reportSummary.assets.value).toLocaleString()}   |   Under Maintenance: ${reportSummary.assets.maintenance}`, col1, y);
                y += 7;

                if (assetCatData.length > 0) {
                    autoTable(
                        ['Category', 'Item Count'],
                        assetCatData.map(d => [d.Name, d.Count])
                    );
                }
            }

            // ── CONTRACTS ────────────────────────────────────────────────
            if (selC) {
                checkY(30);
                sectionTitle('Contracts & Financials');

                doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(60);
                doc.text(`Total Portfolio: $${Number(reportSummary.contracts.value).toLocaleString()}   |   Expiring Within 30 Days: ${reportSummary.contracts.expiring}`, col1, y);
                y += 7;

                if (contractData.length > 0) {
                    autoTable(
                        ['Contract Status', 'Count'],
                        contractData.map(d => [d.Name, d.Count])
                    );
                }
            }

            // ── KNOWLEDGE BASE ───────────────────────────────────────────
            if (selS) {
                checkY(30);
                sectionTitle('Knowledge Base');

                doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(60);
                doc.text(`Published Articles: ${reportSummary.solutions.published}   |   Total Views: ${reportSummary.solutions.views}`, col1, y);
                y += 7;

                if (solutionTopics.length > 0) {
                    autoTable(
                        ['Topic', 'Article Count'],
                        solutionTopics.map(t => [t.Name, t.Count])
                    );
                }
            }

            // ── TEAM WORKLOAD ─────────────────────────────────────────────
            if (selT && workloadData.length > 0) {
                checkY(30);
                sectionTitle('Team Workload');
                autoTable(
                    ['Team Member', 'Open Tickets', 'Active Tasks', 'Total Load'],
                    workloadData.map(u => [u.UserName, u.TicketCount, u.TaskCount, u.TicketCount + u.TaskCount])
                );
            }

            // ── FOOTER on every page ─────────────────────────────────────
            const total = doc.internal.getNumberOfPages();
            for (let i = 1; i <= total; i++) {
                doc.setPage(i);
                doc.setDrawColor(200).setLineWidth(0.3);
                doc.line(margin, pageH - 12, pageW - margin, pageH - 12);
                doc.setFontSize(7).setTextColor(150).setFont(undefined, 'normal');
                doc.text(`Helpora Desk Analytics Report  ·  ${dateStr}`, margin, pageH - 6);
                doc.text(`Page ${i} of ${total}`, pageW - margin, pageH - 6, { align: 'right' });
            }

            doc.save(`ServiceCore_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // 1. Ticket Status Chart (Doughnut)
        new Chart(document.getElementById('ticketStatusChart'), {
            type: 'doughnut',
            data: {
                labels: ticketData.map(d => d.Name),
                datasets: [{
                    data: ticketData.map(d => d.Count),
                    backgroundColor: ['#4361ee', '#4cc9f0', '#f72585', '#7209b7', '#3f37c9'],
                    borderWidth: 0,
                    hoverOffset: 15
                }]
            },
            options: { cutout: '70%', plugins: { legend: { position: 'right' } } }
        });

        // 2. Ticket Aging Chart (Polar Area)
        new Chart(document.getElementById('agingChart'), {
            type: 'polarArea',
            data: {
                labels: ['< 24h', '1-3 Days', '3-7 Days', '> 7 Days'],
                datasets: [{
                    data: [ticketAging.Day1, ticketAging.Day3, ticketAging.Day7, ticketAging.Older],
                    backgroundColor: [
                        'rgba(75, 192, 192, 0.6)',
                        'rgba(54, 162, 235, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(255, 99, 132, 0.6)'
                    ]
                }]
            },
            options: { plugins: { legend: { position: 'bottom' } } }
        });

        // 3. Velocity Chart (Line)
        new Chart(document.getElementById('velocityChart'), {
            type: 'line',
            data: {
                labels: velocityData.map(d => d.Date),
                datasets: [{
                    label: 'Tasks Completed',
                    data: velocityData.map(d => d.Count),
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { 
                    y: { beginAtZero: true, ticks: { stepSize: 1 } },
                    x: { grid: { display: false } }
                }
            }
        });

        // 4. Asset Category Chart (Horizontal Bar)
        new Chart(document.getElementById('assetCategoryChart'), {
            type: 'bar',
            data: {
                labels: assetCatData.map(d => d.Name),
                datasets: [{
                    label: 'Items',
                    data: assetCatData.map(d => d.Count),
                    backgroundColor: 'rgba(76, 201, 240, 0.8)',
                    borderRadius: 8
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: { 
                    x: { beginAtZero: true, grid: { display: false } },
                    y: { grid: { display: false } }
                }
            }
        });
    </script>
}
