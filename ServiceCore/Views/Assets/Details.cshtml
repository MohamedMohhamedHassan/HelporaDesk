@model ServiceCore.Models.Asset
@{
    ViewData["Title"] = "Asset Details: " + Model.Name;
}

<div class="content">
    <div class="mb-5 d-flex justify-content-between align-items-start">
        <div>
            <div class="d-flex align-items-center mb-2">
                <a href="/Assets" class="btn btn-sm btn-link text-muted ps-0 me-2"><i class="bi bi-arrow-left"></i></a>
                <span class="badge bg-brand-blue text-white px-2 fw-500 smaller-1 me-2">@Model.Tag</span>
                <span class="text-muted smaller-1">Registered on @Model.CreatedAt.ToString("MMM dd, yyyy")</span>
            </div>
            <h1 class="display-6 fw-bold mb-1">@Model.Name</h1>
            <p class="text-muted mb-0">@Model.Category?.Name | @Model.Status</p>
        </div>
        <div class="d-flex gap-2">
            <a href="/Assets/Edit/@Model.Id" class="btn btn-outline-secondary shadow-sm btn-sm px-3">
                <i class="bi bi-pencil me-2"></i>Edit
            </a>
            <button class="btn btn-outline-primary shadow-sm btn-sm px-3" data-bs-toggle="modal" data-bs-target="#maintenanceModal">
                <i class="bi bi-tools me-2"></i>Maintenance
            </button>
            <button class="btn btn-primary shadow-sm btn-sm px-3" data-bs-toggle="modal" data-bs-target="#assignModal">
                <i class="bi bi-person-plus me-2"></i>Assign
            </button>
        </div>
    </div>

    <div class="row g-4">
        <!-- Main Content -->
        <div class="col-md-8">
            <!-- Hardware Specs -->
            <div class="card glass border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">Hardware Specifications</h5>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="text-muted smaller-2 d-block mb-1">SERIAL NUMBER</label>
                            <div class="fw-600">@(string.IsNullOrEmpty(Model.SerialNumber) ? "N/A" : Model.SerialNumber)</div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted smaller-2 d-block mb-1">MODEL / SKU</label>
                            <div class="fw-600">@(string.IsNullOrEmpty(Model.Model) ? "N/A" : Model.Model)</div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted smaller-2 d-block mb-1">VENDOR / MANUFACTURER</label>
                            <div class="fw-600">@(string.IsNullOrEmpty(Model.Vendor) ? "N/A" : Model.Vendor)</div>
                        </div>
                        <div class="col-md-6">
                            <label class="text-muted smaller-2 d-block mb-1">CURRENT LOCATION</label>
                            <div class="fw-600">@(string.IsNullOrEmpty(Model.Location) ? "In Stock / Unknown" : Model.Location)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Financials -->
            <div class="card glass border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">Financial & Warranty Details</h5>
                    <div class="row g-4">
                        <div class="col-md-4">
                            <label class="text-muted smaller-2 d-block mb-1" title="Purchase Price">PURCHASE PRICE</label>
                            <div class="h5 fw-bold text-primary mb-0">@Model.PurchaseCost?.ToString("C")</div>
                            <div class="smaller-2 text-muted">Bought: @Model.PurchaseDate?.ToString("MMM dd, yyyy")</div>
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted smaller-2 d-block mb-1">WARRANTY STATUS</label>
                            @if (Model.WarrantyExpiry.HasValue)
                            {
                                <div class="fw-600 @(Model.WarrantyExpiry < DateTime.UtcNow ? "text-danger" : "text-success")">
                                    @(Model.WarrantyExpiry < DateTime.UtcNow ? "Expired" : "Active")
                                </div>
                                <div class="smaller-2 text-muted">Expires: @Model.WarrantyExpiry?.ToString("MMM dd, yyyy")</div>
                            }
                            else
                            {
                                <div class="text-muted">No Warranty Info</div>
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="text-muted smaller-2 d-block mb-1">BOOK VALUE</label>
                            <div class="fw-600">@Model.ResidualValue?.ToString("C")</div>
                            <div class="smaller-2 text-muted">Method: @Model.DepreciationMethod</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lifecycle Timelines -->
            <div class="card glass border-0 shadow-sm">
                <div class="card-header bg-transparent border-0 pt-4 px-4">
                    <ul class="nav nav-tabs card-header-tabs border-0" id="assetTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-600 px-4" id="assignment-tab" data-bs-toggle="tab" data-bs-target="#assignment" type="button" role="tab">Assignments</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-600 px-4" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab">Maintenance</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-600 px-4" id="audit-tab" data-bs-toggle="tab" data-bs-target="#audit" type="button" role="tab">Audit Trail</button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content" id="assetTabsContent">
                        <!-- Assignments -->
                        <div class="tab-pane fade show active" id="assignment" role="tabpanel">
                            @if (Model.Assignments != null && Model.Assignments.Any())
                            {
                                <div class="timeline-v2">
                                    @foreach (var asg in Model.Assignments)
                                    {
                                        <div class="timeline-item mb-4 pb-4 border-bottom last-child-0">
                                            <div class="d-flex justify-content-between">
                                                <div class="d-flex">
                                                    <div class="avatar-sm bg-brand-blue me-3">@asg.User?.Name?.Substring(0,1)</div>
                                                    <div>
                                                        <div class="fw-700">@asg.User?.Name</div>
                                                        <div class="smaller-1 text-muted">@asg.Notes</div>
                                                    </div>
                                                </div>
                                                <div class="text-end">
                                                    <div class="smaller-1 fw-600">@asg.AssignedDate.ToString("MMM dd, yyyy")</div>
                                                    @if (asg.ReturnDate.HasValue)
                                                    {
                                                        <div class="smaller-2 text-muted">Returned: @asg.ReturnDate?.ToString("MMM dd, yyyy")</div>
                                                    }
                                                    else
                                                    {
                                                        <div class="badge bg-primary-subtle text-primary border-0 px-2 fw-500 smaller-2 mt-1">Current</div>
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="bi bi-person-x display-6 text-muted mb-2"></i>
                                    <p class="text-muted small mb-0">No assignment history found.</p>
                                </div>
                            }
                        </div>

                        <!-- Maintenance -->
                        <div class="tab-pane fade" id="maintenance" role="tabpanel">
                            @if (Model.Maintenances != null && Model.Maintenances.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle smaller-1 mb-0">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Type</th>
                                                <th>Description</th>
                                                <th class="text-end">Cost</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var m in Model.Maintenances)
                                            {
                                                <tr>
                                                    <td>@m.MaintenanceDate.ToString("MMM dd, yyyy")</td>
                                                    <td><span class="badge bg-light text-dark border FW-500">@m.Type</span></td>
                                                    <td class="text-muted">@m.Description</td>
                                                    <td class="text-end fw-600 text-primary">@m.Cost?.ToString("C")</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="bi bi-tools display-6 text-muted mb-2"></i>
                                    <p class="text-muted small mb-0">No maintenance logs found.</p>
                                </div>
                            }
                        </div>

                        <!-- Audit Trail -->
                        <div class="tab-pane fade" id="audit" role="tabpanel">
                            @if (Model.Histories != null && Model.Histories.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle smaller-2 mb-0">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Action</th>
                                                <th>Description</th>
                                                <th>User</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var h in Model.Histories.OrderByDescending(h => h.ChangeDate))
                                            {
                                                <tr>
                                                    <td class="text-nowrap">@h.ChangeDate.ToString("yyyy-MM-dd HH:mm")</td>
                                                    <td><span class="badge bg-brand-blue-subtle text-brand-blue border-0 px-2 fw-500">@h.Action</span></td>
                                                    <td class="text-muted">@h.Notes</td>
                                                    <td class="fw-500">@h.ChangedBy</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="bi bi-journal-text display-6 text-muted mb-2"></i>
                                    <p class="text-muted small mb-0">No system events logged yet.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Info -->
        <div class="col-md-4">
            <!-- Current Custodian -->
            <div class="card glass border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3">Current Custodian</h6>
                    @if (Model.User != null)
                    {
                        <div class="d-flex align-items-center">
                            <div class="avatar-md bg-brand-blue me-3">@Model.User.Name?.Substring(0,1)</div>
                            <div>
                                <div class="fw-700">@Model.User.Name</div>
                                <div class="smaller-1 text-muted">@Model.User.Email</div>
                                <div class="smaller-2 text-primary mt-1">Assigned Since @Model.Assignments.FirstOrDefault(a => a.ReturnDate == null)?.AssignedDate.ToString("MMM dd")</div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="text-center py-3">
                            <i class="bi bi-box-seam display-6 text-muted mb-2"></i>
                            <p class="text-muted small mb-0">This asset is currently in inventory.</p>
                            <button class="btn btn-sm btn-outline-primary mt-3 w-100 fw-600" data-bs-toggle="modal" data-bs-target="#assignModal">Assign Now</button>
                        </div>
                    }
                </div>
            </div>

            <!-- Notes -->
            <div class="card glass border-0 shadow-sm">
                <div class="card-body p-4">
                    <h6 class="fw-bold mb-3">Administrator Notes</h6>
                    <div class="smaller-1 text-muted" style="min-height: 100px;">
                        @(string.IsNullOrEmpty(Model.Notes) ? "No notes available for this asset." : Model.Notes)
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Assign Asset -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass border-0 shadow-lg">
            <div class="modal-header border-0 pb-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">Assign Asset</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/Assets/Assign" method="post">
                <input type="hidden" name="assetId" value="@Model.Id" />
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label small fw-600">Select User</label>
                        <select class="form-select border-sc" name="userId" required>
                            <option value="">-- Choose Custodian --</option>
                            @foreach (var user in (List<ServiceCore.Models.User>)ViewBag.Users)
                            {
                                <option value="@user.Id">@user.Name (@user.Email)</option>
                            }
                        </select>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small fw-600">Notes / Instructions</label>
                        <textarea class="form-control border-sc" name="notes" rows="3" placeholder="e.g. Remote work setup..."></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 px-4">
                    <button type="button" class="btn btn-sc-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-sc-primary px-5">Confirm Assignment</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Log Maintenance -->
<div class="modal fade" id="maintenanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass border-0 shadow-lg">
            <div class="modal-header border-0 pb-0 pt-4 px-4">
                <h5 class="modal-title fw-bold">Log Maintenance Activity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="/Assets/LogMaintenance" method="post">
                <input type="hidden" name="assetId" value="@Model.Id" />
                <div class="modal-body p-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label small fw-600">Service Type</label>
                            <select class="form-select border-sc" name="type" required>
                                <option value="Repair">Repair</option>
                                <option value="Upgrade">Upgrade</option>
                                <option value="Routine Check">Routine Check</option>
                                <option value="Cleanup">Cleanup</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-600">Actual Cost</label>
                            <div class="input-group">
                                <span class="input-group-text bg-transparent border-sc">$</span>
                                <input class="form-control border-sc" type="number" step="0.01" name="cost" required />
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-600">Work Description</label>
                            <textarea class="form-control border-sc" name="description" rows="3" placeholder="Detail the work performed..." required></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-0 pb-4 px-4">
                    <button type="button" class="btn btn-sc-secondary px-4" data-bs-modal="modal">Cancel</button>
                    <button type="submit" class="btn btn-sc-primary px-5">Save Entry</button>
                </div>
            </form>
        </div>
    </div>
</div>
