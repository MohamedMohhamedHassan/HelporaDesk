@{
  ViewData["Title"] = "Help";
  Layout = "_Layout";
}

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="text-center mb-4">
                <div class="avatar bg-primary-subtle text-primary mb-3 mx-auto" style="width: 64px; height: 64px; font-size: 2rem;">
                    <i class="bi bi-robot"></i>
                </div>
                <h1 class="h3 fw-bold">How can we help you?</h1>
                <p class="text-muted">Ask me anything about the system, and I'll find the answer for you.</p>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-0">
                    <div id="chat-history" class="p-4" style="height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                        <div class="d-flex mb-3">
                            <div class="avatar bg-primary-subtle text-primary me-2 flex-shrink-0" style="width: 32px; height: 32px; font-size: 0.9rem;">
                                <i class="bi bi-robot"></i>
                            </div>
                            <div class="bg-white p-3 rounded shadow-sm border" style="max-width: 80%;">
                                <p class="mb-0">Hi there! I'm your ServiceCore assistant. You can ask me about creating tickets, managing projects, or any other feature!</p>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border-top bg-white">
                        <form id="chat-form" class="d-flex gap-2">
                            <input type="text" id="chat-input" class="form-control" placeholder="Type your question..." autocomplete="off">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatHistory = document.getElementById('chat-history');

        function appendMessage(role, text, isHtml = false) {
            const isBot = role === 'bot';
            const align = isBot ? '' : 'justify-content-end';
            const bg = isBot ? 'bg-white border' : 'bg-primary text-white';
            const avatar = isBot ? 
                `<div class="avatar bg-primary-subtle text-primary me-2 flex-shrink-0" style="width: 32px; height: 32px; font-size: 0.9rem;"><i class="bi bi-robot"></i></div>` : '';

            const html = `
                <div class="d-flex mb-3 ${align} message-fade-in">
                    ${avatar}
                    <div class="${bg} p-3 rounded-4 shadow-sm" style="max-width: 85%; border-radius: ${isBot ? '0 15px 15px 15px' : '15px 15px 0 15px'} !important;">
                        ${isHtml ? text : `<p class="mb-0">${text}</p>`}
                    </div>
                </div>
            `;
            
            chatHistory.insertAdjacentHTML('beforeend', html);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = chatInput.value.trim();
            if (!query) return;

            // User Message
            appendMessage('user', query);
            chatInput.value = '';

            // Loading / Typing...
            const loadingId = 'loading-' + Date.now();
            const loadingHtml = `
                <div class="d-flex mb-3 message-fade-in" id="${loadingId}">
                    <div class="avatar bg-primary-subtle text-primary me-2 flex-shrink-0" style="width: 32px; height: 32px; font-size: 0.9rem;"><i class="bi bi-robot"></i></div>
                    <div class="bg-white p-3 border shadow-sm" style="border-radius: 0 15px 15px 15px; width: 60px;">
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                </div>
            `;
            chatHistory.insertAdjacentHTML('beforeend', loadingHtml);
            chatHistory.scrollTop = chatHistory.scrollHeight;

            try {
                const res = await fetch(`/Help/Chat?query=${encodeURIComponent(query)}`);
                const data = await res.json();
                
                document.getElementById(loadingId).remove();

                if (data.success) {
                    // Start with the main bot response text
                    let content = `<p class="mb-0">${data.botResponse || "I found what you were looking for."}</p>`;
                    
                    // If there are specific results (Solutions)
                    if (data.results && data.results.length > 0) {
                        content += '<div class="mt-3 border-top pt-2"><ul class="list-unstyled mb-0">';
                        data.results.forEach(item => {
                            content += `
                                <li class="mb-2">
                                    <a href="/Solutions/Details/${item.id}" class="text-decoration-none fw-bold small text-primary" target="_blank">
                                        <i class="bi bi-journal-text me-1"></i> ${item.title}
                                    </a>
                                    <p class="small text-muted mb-0 text-truncate">${item.preview}</p>
                                </li>`;
                        });
                        content += '</ul></div>';
                    }
                    
                    appendMessage('bot', content, true);
                } else {
                    appendMessage('bot', data.message || "I'm sorry, I couldn't process that request.");
                }

            } catch (err) {
                if(document.getElementById(loadingId)) document.getElementById(loadingId).remove();
                appendMessage('bot', "Sorry, I encountered an error while searching.");
                console.error(err);
            }
        });
    </script>
    <style>
        .message-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-dots {
            display: flex;
            gap: 4px;
            justify-content: center;
            align-items: center;
            height: 10px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            background-color: var(--bs-primary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @@keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
}
