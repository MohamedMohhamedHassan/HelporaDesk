@model IEnumerable<ServiceCore.Models.Ticket>
@{
    ViewData["Title"] = "Ticket Manager";
    var page = (int)(ViewData["Page"] ?? 1);
    var pageSize = (int)(ViewData["PageSize"] ?? 20);
    var total = (int)(ViewData["TotalCount"] ?? Model.Count());
}

<div class="content">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-3 mb-4">
        <div>
            <h1 class="h3 fw-bold mb-1">Ticket Manager</h1>
            <p class="text-muted small mb-0">Manage and track all support requests across the organization.</p>
        </div>
        <a class="btn btn-primary" href="/TicketsManager/Create">
            <i class="bi bi-plus-lg"></i> Create Ticket
        </a>
    </div>

    <!-- Modern Filters Bar -->
    <div class="card glass mb-4">
        <div class="card-body py-3">
            <form method="get" class="row g-3 align-items-center">
                <div class="col-12 col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-0 text-muted"><i class="bi bi-search"></i></span>
                        <input class="form-control bg-transparent border-0 ps-0" name="search" value="@(ViewData["Search"] ?? "")" placeholder="Search by subject, ID, or user..." />
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <select name="statusId" class="form-select fw-600">
                        <option value="">All Statuses</option>
                        @if (ViewBag.Statuses != null) {
                            foreach (var s in (List<ServiceCore.Models.TicketStatus>)ViewBag.Statuses) {
                                <option value="@s.Id" selected="@(ViewData["StatusId"]?.ToString() == s.Id.ToString() ? "selected" : null)">@s.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-6 col-md-3">
                    <select name="priorityId" class="form-select fw-600">
                        <option value="">All Priorities</option>
                        @if (ViewBag.Priorities != null) {
                            foreach (var p in (List<ServiceCore.Models.TicketPriority>)ViewBag.Priorities) {
                                <option value="@p.Id" selected="@(ViewData["PriorityId"]?.ToString() == p.Id.ToString() ? "selected" : null)">@p.Name</option>
                            }
                        }
                    </select>
                </div>
                <div class="col-12 col-md-2 text-md-end">
                    <button class="btn btn-primary w-100" type="submit">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modern List Header -->
    <div class="d-flex px-4 py-2 text-muted small fw-700 text-uppercase letter-spacing-1 mb-2">
        <div style="width: 80px">ID</div>
        <div class="flex-grow-1">Ticket / Request</div>
        <div style="width: 150px">Status</div>
        <div style="width: 150px">Priority</div>
        <div style="width: 180px">Updated</div>
        <div style="width: 140px" class="text-end">Actions</div>
    </div>

    <!-- Ticket List -->
    <div class="d-grid gap-3">
        @foreach (var t in Model)
        {
            <div class="card glass-elevated border-0">
                <div class="card-body py-3">
                    <div class="d-flex align-items-center">
                        <div style="width: 80px" class="fw-bold text-primary">#@t.Id</div>
                        <div class="flex-grow-1">
                            <div class="fw-bold mb-0">@t.Subject</div>
                            <div class="text-muted small">
                                <span class="badge bg-primary-subtle text-primary me-2">@t.Category?.Name</span>
                                <i class="bi bi-person me-1"></i> @t.Requester?.Name
                            </div>
                        </div>
                        <div style="width: 150px">
                            <span class="badge @(t.Status?.Name == "Closed" ? "text-bg-success" : (t.Status?.Name == "Open" ? "text-bg-primary" : "text-bg-warning")) opacity-90">
                                @t.Status?.Name
                            </span>
                        </div>
                        <div style="width: 150px">
                            @{
                                var pColor = t.Priority?.Name switch {
                                    "Critical" => "text-danger",
                                    "High" => "text-warning",
                                    _ => "text-info"
                                };
                            }
                            <span class="fw-600 @pColor">
                                <i class="bi bi-circle-fill smaller me-1"></i> @t.Priority?.Name
                            </span>
                        </div>
                        <div style="width: 180px" class="text-muted small">
                            @(t.UpdatedAt?.ToString("MMM dd, yyyy HH:mm") ?? t.CreatedAt.ToString("MMM dd, yyyy HH:mm"))
                        </div>
                        <div style="width: 140px" class="text-end">
                            <div class="d-flex justify-content-end gap-1">
                                <a href="/TicketsManager/Details/@t.Id" class="btn btn-sm btn-outline-primary p-2" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/TicketsManager/Edit/@t.Id" class="btn btn-sm btn-outline-primary p-2" title="Edit Record">
                                    <i class="bi bi-pencil"></i>
                                </a>
                                <form method="post" asp-action="Delete" asp-route-id="@t.Id" class="d-inline">
                                    <button type="submit" class="btn btn-sm btn-outline-danger p-2" title="Archive" onclick="return confirm('Archive this ticket?')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Pagination -->
    @if (total > pageSize)
    {
        <nav class="mt-5">
            <ul class="pagination pagination-md justify-content-center">
                @for (var i = 1; i <= (int)Math.Ceiling(total / (double)pageSize); i++)
                {
                    <li class="page-item @(i == page ? "active" : "")">
                        <a class="page-link glass border-0 mx-1 rounded-3" href="?page=@i">@i</a>
                    </li>
                }
            </ul>
        </nav>
    }
</div>
