@{
    ViewData["Title"] = "General Settings";
}

<h1>General</h1>

<form>
</form>

<form id="settingsForm">
    <div class="mb-3">
        <label class="form-label">Site name</label>
        <input id="siteName" class="form-control" />
    </div>
    <div class="mb-3">
        <label class="form-label">Default timezone</label>
        <select id="timezone" class="form-select">
            <option value="UTC">UTC</option>
            <option value="America/New_York">America/New_York</option>
            <option value="Europe/London">Europe/London</option>
        </select>
    </div>
    <button id="saveBtn" class="btn btn-primary">Save</button>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    async function loadSettings() {
        try {
            const res = await fetch('/api/SettingsApi');
            if (!res.ok) return;
            const settings = await res.json();
            const find = (k) => (settings.find(s => s.key === k) || {}).value || '';
            document.getElementById('siteName').value = find('SiteName');
            document.getElementById('timezone').value = find('DefaultTimezone') || 'UTC';
        } catch (e) {
            console.error('Failed to load settings', e);
        }
    }

    loadSettings();

    document.getElementById('saveBtn').addEventListener('click', async function (e) {
        e.preventDefault();
        const payloads = [
            { key: 'SiteName', value: document.getElementById('siteName').value },
            { key: 'DefaultTimezone', value: document.getElementById('timezone').value }
        ];

        for (const p of payloads) {
            try {
                await fetch('/api/SettingsApi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(p)
                });
            } catch (e) {
                console.error('Save failed', e);
            }
        }

        const alertEl = document.createElement('div');
        alertEl.className = 'alert alert-success mt-3';
        alertEl.textContent = 'Settings saved';
        const form = document.getElementById('settingsForm');
        form.parentNode.insertBefore(alertEl, form.nextSibling);
        setTimeout(() => alertEl.remove(), 3000);
    });
});
</script>
</form>
